<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ops Communication Admin (POC Connected)</title>
    <script src="config.js"></script>
    <style>
        /* --- Branding & Core UI --- */
        :root {
            --se-orange: #F58220;
            --se-red: #EE3124;
            --se-green: #008060;
            --se-black: #2d2d2d;
            --bg-gray: #f4f6f8;
            --border-color: #ddd;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            padding: 40px 20px;
            color: var(--se-black);
        }

        .widget-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            border-top: 6px solid var(--se-orange);
            margin-bottom: 40px;
        }

        .header {
            padding: 24px;
            background: white;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h2 { margin: 0; color: var(--se-green); font-weight: 700; }
        .header .badge { background-color: var(--se-red); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }

        form { padding: 30px; }
        .form-group { margin-bottom: 24px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; }
        .sub-label { display: block; font-size: 0.85rem; color: #888; margin-bottom: 8px; }

        /* Inputs */
        input[type="text"], select, textarea {
            width: 100%; padding: 12px; border: 2px solid var(--border-color);
            border-radius: 6px; font-size: 1rem; transition: border-color 0.3s;
            box-sizing: border-box; font-family: inherit;
        }
        input[type="text"]:focus, select:focus, textarea:focus { border-color: var(--se-green); outline: none; }

        /* Smart Search Area */
        .smart-search-area { background: #fafafa; padding: 15px; border: 1px solid #eee; border-radius: 6px; }
        textarea.store-input {
            font-family: 'Monaco', 'Menlo', monospace; 
            font-size: 0.9rem; height: 100px; resize: vertical;
        }
        
        /* Table Styles */
        .table-container { margin-top: 15px; border: 1px solid #eee; border-radius: 4px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #eee; text-align: left; padding: 10px; font-weight: 600; }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f1f1; }
        tr:last-child td { border-bottom: none; }
        .status-active { color: var(--se-green); font-weight: bold; }
        .status-inactive { color: var(--se-red); font-weight: bold; }

        /* Pagination */
        .pagination { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border-top: 1px solid #eee; }
        .page-btn { padding: 5px 10px; background: #eee; border: none; border-radius: 4px; cursor: pointer; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 0.85rem; color: #666; }

        /* Error Box */
        .error-summary {
            display: none;
            background-color: #fff5f5; border: 1px solid #fc8181;
            color: #c53030; padding: 15px; border-radius: 6px; margin-bottom: 20px;
        }
        .error-title { font-weight: bold; display: block; margin-bottom: 5px; }

        /* Buttons */
        .btn-secondary { background: #666; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px; }
        
        button.submit-btn {
            width: 100%; padding: 15px; background-color: var(--se-green); color: white;
            border: none; border-radius: 6px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; transition: background 0.3s; text-transform: uppercase; letter-spacing: 1px;
        }
        button.submit-btn:hover { background-color: #006b50; }
        button.submit-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        button.finished { background-color: #2d2d2d; cursor: default; }

        /* File Upload */
        .file-drop-area {
            position: relative; display: flex; align-items: center; width: 100%;
            padding: 12px; border: 2px dashed #ccc; border-radius: 6px;
            background-color: #fafafa; box-sizing: border-box;
        }
        .file-drop-area.active { border-color: var(--se-orange); background-color: #fffaf5; }
        input[type="file"] { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* Logs Console */
        .console-log {
            background: #2d2d2d; color: #00ff9d; padding: 20px;
            font-family: monospace; font-size: 0.85rem;
            max-height: 200px; overflow-y: auto; display: none;
            margin: 20px auto; border-radius: 8px; max-width: 800px;
        }
        .log-error { color: #ff6b6b; }
    </style>
</head>
<body>

<div class="widget-container">
    <div class="header">
        <h2>Ops Admin Portal</h2>
        <span class="badge">ADHOC POST</span>
    </div>

    <form id="opsForm">
        
        <div class="form-group">
            <label for="postTitle">Post Title</label>
            <input type="text" id="postTitle" placeholder="e.g. Q4 Audit Requirements" required>
        </div>

        <div class="form-group">
            <label for="category">Category</label>
            <select id="category" required>
                <option value="" disabled selected>Select a category</option>
                <option value="Merchandising">Merchandising</option>
                <option value="Marketing">Marketing</option>
                <option value="Audit">Audit</option>
                <option value="Operations">Operations</option>
            </select>
        </div>

        <div class="form-group">
            <label>Target Stores (Smart Search)</label>
            <span class="sub-label">Paste Store IDs below. Spaces, commas, or new lines act as separators.</span>
            
            <div class="smart-search-area">
                <textarea id="storeInput" class="store-input" placeholder="Paste IDs here (e.g., 10001 10002 10005)..."></textarea>
                <button type="button" class="btn-secondary" id="verifyBtn" onclick="verifyStores()">Verify Stores</button>
            </div>

            <div class="table-container" id="resultsContainer" style="display:none;">
                <table>
                    <thead>
                        <tr>
                            <th>Store ID</th>
                            <th>Store Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="storeTableBody">
                        </tbody>
                </table>
                <div class="pagination">
                    <button type="button" class="page-btn" id="prevPageBtn" onclick="changePage(-1)">Previous</button>
                    <span class="page-info" id="pageInfo">Page 1 of 1</span>
                    <button type="button" class="page-btn" id="nextPageBtn" onclick="changePage(1)">Next</button>
                </div>
            </div>
            <p id="storeCountMsg" style="font-size: 0.9rem; color: var(--se-green); font-weight:bold; margin-top:8px;"></p>
        </div>

        <div class="form-group">
            <label>Task List (CSV)</label>
            <span class="sub-label">Cols: <code>Task Content</code>, <code>Description</code>, <code>Due Date</code></span>
            <div class="file-drop-area">
                <span class="file-msg">Drag and drop or click to select CSV</span>
                <input type="file" id="csvTasks" accept=".csv" required>
            </div>
        </div>

        <div class="form-group">
            <label>Field Merges (CSV)</label>
            <span class="sub-label">Updates user attributes via import API</span>
            <div class="file-drop-area">
                <span class="file-msg">Drag and drop or click to select CSV</span>
                <input type="file" id="csvMerges" accept=".csv" required>
            </div>
        </div>

        <div class="form-group" style="display:flex; align-items:center;">
            <input type="checkbox" id="notifyUsers" style="width:20px; height:20px; margin-right:10px;">
            <label for="notifyUsers" style="margin-bottom:0; cursor:pointer;">Notify users in the new channel</label>
        </div>

        <div id="submissionError" class="error-summary">
            <span class="alert-title">⚠️ Submission Blocked: Data Integrity Issues</span>
            <p style="margin: 5px 0;">The following IDs are invalid or inactive:</p>
            <span id="invalidIdList" style="font-family:monospace;"></span>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">Create Adhoc Post</button>
    </form>
</div>

<div id="consoleLog" class="console-log">
    <strong>System Logs:</strong><br>
</div>

<div class="past-submissions">
    <h3 style="color:#555; margin-bottom:15px;">Past Submissions</h3>
    <div class="submission-card">
        <div class="sub-details">
            <h4>Safety Protocol Update</h4>
            <p>Operations • 2,400 Stores • Posted 2 days ago</p>
        </div>
        <button class="btn-edit">View</button>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION & HELPERS ---
    
    // Ensure config.js is loaded
    if (typeof CONFIG === 'undefined') {
        alert("CRITICAL ERROR: config.js is missing. Please create it with your API credentials.");
    }

    const { API_TOKEN, INSTALLATION_ID, BASE_URL } = CONFIG;

    function log(msg, type = 'info') {
        const consoleDiv = document.getElementById('consoleLog');
        consoleDiv.style.display = 'block';
        const span = type === 'error' ? '<span class="log-error">' : '<span>';
        consoleDiv.innerHTML += `<div>${span}[${new Date().toLocaleTimeString()}] ${msg}</span></div>`;
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${msg}`);
    }

    // Generic API Request Helper
    async function apiRequest(endpoint, method, body = null) {
        const headers = {
            'Authorization': `Basic ${API_TOKEN}`, // Staffbase uses Basic Auth usually, or Bearer. Check your docs.
            // If Bearer: 'Authorization': `Bearer ${API_TOKEN}`, 
            'Content-Type': 'application/json'
        };

        // Note: For Basic Auth, token often needs to be base64 encoded 'username:password'.
        // Assuming your config.js has the correct token format string provided.

        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);

        try {
            const response = await fetch(`${BASE_URL}${endpoint}`, options);
            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`${response.status} ${response.statusText} - ${errText}`);
            }
            // Return JSON if content exists, else null
            return response.status !== 204 ? await response.json() : null;
        } catch (error) {
            log(`API Failed (${endpoint}): ${error.message}`, 'error');
            throw error;
        }
    }

    // CSV Parser Helper
    function parseCSV(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const rows = text.split('\n').filter(r => r.trim() !== '');
                const headers = rows[0].split(',').map(h => h.trim());
                const data = rows.slice(1).map(row => {
                    const values = row.split(',');
                    return headers.reduce((obj, header, index) => {
                        obj[header] = values[index] ? values[index].trim() : '';
                        return obj;
                    }, {});
                });
                resolve(data);
            };
            reader.onerror = reject;
            reader.readAsText(file);
        });
    }


    // --- 2. STORE VERIFICATION LOGIC (REAL API) ---
    
    let validStores = []; // Stores User Objects found via API
    let invalidIds = [];  // IDs that 404'd
    
    // Pagination State
    let currentPage = 1;
    const ITEMS_PER_PAGE = 5;

    async function verifyStores() {
        const rawInput = document.getElementById('storeInput').value;
        const errorBox = document.getElementById('submissionError');
        const resultsContainer = document.getElementById('resultsContainer');
        const countMsg = document.getElementById('storeCountMsg');
        const verifyBtn = document.getElementById('verifyBtn');

        // Reset
        validStores = [];
        invalidIds = [];
        errorBox.style.display = 'none';
        
        if (!rawInput.trim()) return;

        verifyBtn.disabled = true;
        verifyBtn.innerText = "Checking API...";
        log("Starting Batch Verification against User API...");

        // 1. Clean Input
        const searchIds = rawInput.split(/[\s,]+/).filter(Boolean);
        const uniqueIds = [...new Set(searchIds)];

        // 2. Fetch Loop (In a real app, use a bulk endpoint if available. Here we loop.)
        // We limit concurrency to avoid browser stalling
        
        for (const id of uniqueIds) {
            try {
                // ASSUMPTION: User API allows search by ExternalID (Store ID)
                // Endpoint: GET /users?externalID={id}
                const res = await apiRequest(`/users?externalID=${id}`, 'GET');
                
                // Check if API returned a user list
                if (res && res.data && res.data.length > 0) {
                    const user = res.data[0]; // Assuming first match is correct
                    validStores.push({
                        id: id,
                        userId: user.id, // We need the internal User ID for later steps
                        name: `${user.firstName} ${user.lastName}`, 
                        status: 'Active' // Assuming if they exist, they are active
                    });
                } else {
                    invalidIds.push(id);
                }
            } catch (err) {
                console.error(err);
                invalidIds.push(`${id} (Error)`);
            }
        }

        log(`Verification Complete. Valid: ${validStores.length}, Invalid: ${invalidIds.length}`);
        
        // 3. Update UI
        verifyBtn.disabled = false;
        verifyBtn.innerText = "Verify Stores";

        if (validStores.length > 0) {
            resultsContainer.style.display = 'block';
            countMsg.innerText = `Verified ${validStores.length} stores via API.`;
            currentPage = 1;
            renderTable();
        }

        if (invalidIds.length > 0) {
            document.getElementById('invalidIdList').innerText = invalidIds.join(', ');
            errorBox.style.display = 'block';
        }
    }

    // Pagination Rendering
    function renderTable() {
        const tbody = document.getElementById('storeTableBody');
        tbody.innerHTML = '';
        const start = (currentPage - 1) * ITEMS_PER_PAGE;
        const pageData = validStores.slice(start, start + ITEMS_PER_PAGE);

        pageData.forEach(store => {
            tbody.innerHTML += `
                <tr>
                    <td>${store.id}</td>
                    <td>${store.name}</td>
                    <td class="status-active">Active</td>
                </tr>`;
        });
        
        const maxPage = Math.ceil(validStores.length / ITEMS_PER_PAGE) || 1;
        document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${maxPage}`;
        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = currentPage === maxPage;
    }

    function changePage(dir) {
        const maxPage = Math.ceil(validStores.length / ITEMS_PER_PAGE);
        if (dir === -1 && currentPage > 1) currentPage--;
        if (dir === 1 && currentPage < maxPage) currentPage++;
        renderTable();
    }


    // --- 3. SUBMISSION FLOW (THE CHAIN) ---

    document.getElementById('opsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Integrity Check
        if (invalidIds.length > 0) {
            alert("Please remove invalid Store IDs before submitting.");
            return;
        }
        if (validStores.length === 0) {
            alert("Please verify stores first.");
            return;
        }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "Processing...";
        
        try {
            // A. Get Form Data
            const title = document.getElementById('postTitle').value;
            const category = document.getElementById('category').value;
            const targetUserIds = validStores.map(s => s.userId); // Internal IDs needed for API

            // B. Parse CSVs
            log("Parsing CSV Files...");
            const taskData = await parseCSV(document.getElementById('csvTasks').files[0]);
            const mergeData = await parseCSV(document.getElementById('csvMerges').files[0]);


            // STEP 1: Create Channel
            log("Creating Channel...");
            // Endpoint: POST /channels
            const channelPayload = { 
                name: `${category}: ${title}`, 
                type: "news",
                visibleTo: targetUserIds 
            };
            const channelRes = await apiRequest('/channels', 'POST', channelPayload);
            const channelID = channelRes.id; // Capture ID
            log(`Channel Created: ${channelID}`);


            // STEP 2: Create Task List
            log("Creating Task List...");
            // Endpoint: POST /tasks/{installationId}/lists
            const listPayload = { title: `${title} Tasks`, assignedTo: targetUserIds };
            const listRes = await apiRequest(`/tasks/${INSTALLATION_ID}/lists`, 'POST', listPayload);
            const listID = listRes.id;


            // STEP 3: Create Tasks (Loop)
            log(`Creating ${taskData.length} Tasks...`);
            for (const task of taskData) {
                // Endpoint: POST /tasks/{installationId}/task
                await apiRequest(`/tasks/${INSTALLATION_ID}/task`, 'POST', {
                    listId: listID,
                    title: task['Task Content'],
                    description: task['Description'],
                    dueDate: task['Due Date']
                });
            }


            // STEP 4: Create News Post
            log("Publishing News Post...");
            // Endpoint: POST /channels/{channelID}/posts
            const newsPayload = {
                title: title,
                content: `<p><strong>Category:</strong> ${category}</p><p>Please complete the attached task list.</p>`,
                image: null 
            };
            await apiRequest(`/channels/${channelID}/posts`, 'POST', newsPayload);


            // STEP 5: CSV Import (Field Merges)
            // Usually this requires creating an Import Job first
            if (mergeData.length > 0) {
                log("Processing Field Merges...");
                
                // 5a. Create Import Job
                // Endpoint: POST /users/imports (Assumed standard endpoint)
                const importJob = await apiRequest('/users/imports', 'POST', { type: "update" });
                const importId = importJob.id;
                
                // 5b. Upload Data
                // Endpoint: POST /users/imports/{importId}
                // Note: APIs often accept raw CSV string here, or JSON array. Sending JSON array for POC.
                await apiRequest(`/users/imports/${importId}`, 'POST', mergeData);
            }

            log("All Operations Successful!", "success");
            alert("Success! Adhoc Post, Tasks, and Field Updates created.");
            btn.innerText = "Done";
            btn.classList.add('finished');

        } catch (err) {
            log("Fatal Error: " + err.message, 'error');
            alert("An error occurred. Check the console log at the bottom.");
            btn.disabled = false;
            btn.innerText = "Retry";
        }
    });

    // File UI Helper
    document.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', function() {
            this.parentElement.querySelector('.file-msg').textContent = this.files[0].name;
            this.parentElement.classList.add('active');
        });
    });

</script>
</body>
</html>
