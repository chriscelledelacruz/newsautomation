<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Creation Builder</title>
    <style>
        /* --- Branding & Core UI --- */
        :root {
            --se-orange: #F58220;
            --se-red: #EE3124;
            --se-green: #008060;
            --se-black: #2d2d2d;
            --bg-gray: #f4f6f8;
            --border-color: #ddd;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            padding: 40px 20px;
            color: var(--se-black);
        }

        .widget-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            border-top: 6px solid var(--se-orange);
            margin-bottom: 40px;
        }

        .header {
            padding: 24px;
            background: white;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h2 { margin: 0; color: var(--se-green); font-weight: 700; }
        .header .badge { background-color: var(--se-red); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }

        form { padding: 30px; }
        .form-group { margin-bottom: 24px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; }
        .sub-label { display: block; font-size: 0.85rem; color: #888; margin-bottom: 8px; }

        /* Inputs */
        input[type="text"], select, textarea {
            width: 100%; padding: 12px; border: 2px solid var(--border-color);
            border-radius: 6px; font-size: 1rem; transition: border-color 0.3s;
            box-sizing: border-box; font-family: inherit;
        }
        input[type="text"]:focus, select:focus, textarea:focus { border-color: var(--se-green); outline: none; }

        /* Smart Search Area */
        .smart-search-area { background: #fafafa; padding: 15px; border: 1px solid #eee; border-radius: 6px; }
        textarea.store-input {
            font-family: 'Monaco', 'Menlo', monospace; 
            font-size: 0.9rem; height: 100px; resize: vertical;
        }
        
        /* Table Styles */
        .table-container { margin-top: 15px; border: 1px solid #eee; border-radius: 4px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #eee; text-align: left; padding: 10px; font-weight: 600; }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f1f1; }
        tr:last-child td { border-bottom: none; }
        .status-active { color: var(--se-green); font-weight: bold; }
        .status-inactive { color: var(--se-red); font-weight: bold; }

        /* Pagination */
        .pagination { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border-top: 1px solid #eee; }
        .page-btn { padding: 5px 10px; background: #eee; border: none; border-radius: 4px; cursor: pointer; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 0.85rem; color: #666; }

        /* Error Box */
        .error-summary {
            display: none;
            background-color: #fff5f5; border: 1px solid #fc8181;
            color: #c53030; padding: 15px; border-radius: 6px; margin-bottom: 20px;
        }
        .error-title { font-weight: bold; display: block; margin-bottom: 5px; }

        /* Buttons */
        .btn-secondary { background: #666; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px; }
        
        button.submit-btn {
            width: 100%; padding: 15px; background-color: var(--se-green); color: white;
            border: none; border-radius: 6px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; transition: background 0.3s; text-transform: uppercase; letter-spacing: 1px;
        }
        button.submit-btn:hover { background-color: #006b50; }
        button.submit-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* File Upload */
        .file-drop-area {
            position: relative; display: flex; align-items: center; width: 100%;
            padding: 12px; border: 2px dashed #ccc; border-radius: 6px;
            background-color: #fafafa; box-sizing: border-box;
        }
        .file-drop-area.active { border-color: var(--se-orange); background-color: #fffaf5; }
        input[type="file"] { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* Past Submissions Section */
        .past-submissions { max-width: 800px; margin: 0 auto; }
        .submission-card {
            background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;
        }
        .sub-details h4 { margin: 0 0 5px 0; color: #333; }
        .sub-details p { margin: 0; color: #777; font-size: 0.9rem; }
        .btn-edit { background: white; border: 2px solid var(--se-orange); color: var(--se-orange); padding: 6px 14px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-edit:hover { background: var(--se-orange); color: white; }

        /* Console Output (Hidden for cleaner UI, can be toggled) */
        #console-output { display: none; }
    </style>
</head>
<body>

<div class="widget-container">
    <div class="header">
        <h2>Ops Admin Portal</h2>
        <span class="badge">ADHOC POST</span>
    </div>

    <form id="opsForm">
        
        <div class="form-group">
            <label for="postTitle">Post Title</label>
            <input type="text" id="postTitle" placeholder="e.g. Q4 Audit Requirements" required>
        </div>

        <div class="form-group">
            <label for="category">Category</label>
            <select id="category" required>
                <option value="" disabled selected>Select a category</option>
                <option value="Merchandising">Merchandising</option>
                <option value="Marketing">Marketing</option>
                <option value="Audit">Audit</option>
                <option value="Operations">Operations</option>
            </select>
        </div>

        <div class="form-group">
            <label>Target Stores (Smart Search)</label>
            <span class="sub-label">Paste Store IDs below. Spaces, commas, or new lines act as separators.</span>
            
            <div class="smart-search-area">
                <textarea id="storeInput" class="store-input" placeholder="Paste IDs here (e.g., 10001 10002 10005)..."></textarea>
                <button type="button" class="btn-secondary" onclick="verifyStores()">Verify Stores</button>
            </div>

            <div class="table-container" id="resultsContainer" style="display:none;">
                <table>
                    <thead>
                        <tr>
                            <th>Store ID</th>
                            <th>Store Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="storeTableBody">
                        </tbody>
                </table>
                <div class="pagination">
                    <button type="button" class="page-btn" id="prevPageBtn" onclick="changePage(-1)">Previous</button>
                    <span class="page-info" id="pageInfo">Page 1 of 1</span>
                    <button type="button" class="page-btn" id="nextPageBtn" onclick="changePage(1)">Next</button>
                </div>
            </div>
            <p id="storeCountMsg" style="font-size: 0.9rem; color: var(--se-green); font-weight:bold; margin-top:8px;"></p>
        </div>

        <div class="form-group">
            <label>Task List (CSV)</label>
            <span class="sub-label">Cols: <code>Task Content</code>, <code>Description</code>, <code>Due Date</code></span>
            <div class="file-drop-area">
                <span class="file-msg">Drag and drop or click to select CSV</span>
                <input type="file" id="csvTasks" accept=".csv">
            </div>
        </div>

        <div class="form-group">
            <label>Field Merges (CSV)</label>
            <span class="sub-label">Updates user attributes via import API</span>
            <div class="file-drop-area">
                <span class="file-msg">Drag and drop or click to select CSV</span>
                <input type="file" id="csvMerges" accept=".csv">
            </div>
        </div>

        <div class="form-group" style="display:flex; align-items:center;">
            <input type="checkbox" id="notifyUsers" style="width:20px; height:20px; margin-right:10px;">
            <label for="notifyUsers" style="margin-bottom:0; cursor:pointer;">Notify users in the new channel</label>
        </div>

        <div id="submissionError" class="error-summary">
            <span class="alert-title">⚠️ Submission Blocked: Data Integrity Issues</span>
            <p style="margin: 5px 0;">The following IDs are invalid or inactive:</p>
            <span id="invalidIdList" style="font-family:monospace;"></span>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">Create Adhoc Post</button>
    </form>
</div>

<div class="past-submissions">
    <h3 style="color:#555; margin-bottom:15px;">Past Submissions</h3>
    
    <div class="submission-card">
        <div class="sub-details">
            <h4>Safety Protocol Update</h4>
            <p>Operations • 2,400 Stores • Posted 2 days ago</p>
        </div>
        <button class="btn-edit" onclick="loadPreviousPost('Safety Protocol Update')">Edit / View</button>
    </div>

    <div class="submission-card">
        <div class="sub-details">
            <h4>Q4 Merch Plan</h4>
            <p>Merchandising • 13,000 Stores • Posted 1 week ago</p>
        </div>
        <button class="btn-edit" onclick="loadPreviousPost('Q4 Merch Plan')">Edit / View</button>
    </div>

    <div class="submission-card">
        <div class="sub-details">
            <h4>System Maintenance Alert</h4>
            <p>IT/Audit • 500 Stores • Posted 2 weeks ago</p>
        </div>
        <button class="btn-edit" onclick="loadPreviousPost('System Maintenance Alert')">Edit / View</button>
    </div>
</div>

<script>
    // --- 1. MOCK DATABASE (13,000 Stores) ---
    // Simulating a large DB locally for the demo
    console.log("Generating Mock Database...");
    const MOCK_DB = Array.from({ length: 13000 }, (_, i) => {
        const id = (10000 + i).toString();
        // Mark every 50th store as "Inactive" to demonstrate data validation
        const isActive = i % 50 !== 0; 
        return {
            id: id,
            name: `7-Eleven Store #${id}`,
            status: isActive ? 'Active' : 'Inactive'
        };
    });

    // --- 2. STORE SEARCH STATE ---
    let validStores = [];
    let invalidIds = [];
    let currentPage = 1;
    const ITEMS_PER_PAGE = 5;

    // --- 3. SEARCH ALGORITHM ---
    function verifyStores() {
        const rawInput = document.getElementById('storeInput').value;
        const errorBox = document.getElementById('submissionError');
        const resultsContainer = document.getElementById('resultsContainer');
        const countMsg = document.getElementById('storeCountMsg');

        // Reset State
        validStores = [];
        invalidIds = [];
        errorBox.style.display = 'none';

        if (!rawInput.trim()) {
            resultsContainer.style.display = 'none';
            countMsg.innerText = "";
            return;
        }

        // A. Smart Split: Handle spaces, commas, newlines
        const searchIds = rawInput.split(/[\s,]+/).filter(Boolean);
        const uniqueSearchIds = [...new Set(searchIds)]; // Dedup input

        // B. Lookup Algorithm
        // For 13k items, a simple filter is fast enough. For 1M+, we'd use a Map/Object for O(1) lookup.
        const dbMap = new Map(MOCK_DB.map(s => [s.id, s]));

        uniqueSearchIds.forEach(id => {
            const store = dbMap.get(id);
            if (store) {
                // Check if Active
                if (store.status === 'Active') {
                    validStores.push(store);
                } else {
                    // It exists but is Inactive -> Treat as Invalid for this purpose
                    invalidIds.push(`${id} (Inactive)`);
                }
            } else {
                // ID doesn't exist
                invalidIds.push(`${id} (Not Found)`);
            }
        });

        // C. Render Results
        currentPage = 1;
        renderTable();
        resultsContainer.style.display = 'block';
        countMsg.innerText = `Found ${validStores.length} valid stores ready for targeting.`;

        // D. Handle Errors
        if (invalidIds.length > 0) {
            document.getElementById('invalidIdList').innerText = invalidIds.join(', ');
            errorBox.style.display = 'block';
            // Optional: Auto-scroll to error?
            // errorBox.scrollIntoView({behavior: "smooth"}); 
        }
    }

    // --- 4. PAGINATION LOGIC ---
    function renderTable() {
        const tbody = document.getElementById('storeTableBody');
        tbody.innerHTML = '';

        const start = (currentPage - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const pageData = validStores.slice(start, end);

        if (pageData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No valid stores found yet.</td></tr>';
            updatePaginationControls(0);
            return;
        }

        pageData.forEach(store => {
            const row = `<tr>
                <td>${store.id}</td>
                <td>${store.name}</td>
                <td class="status-active">${store.status}</td>
            </tr>`;
            tbody.innerHTML += row;
        });

        updatePaginationControls(validStores.length);
    }

    function changePage(dir) {
        const maxPage = Math.ceil(validStores.length / ITEMS_PER_PAGE);
        if (dir === -1 && currentPage > 1) currentPage--;
        if (dir === 1 && currentPage < maxPage) currentPage++;
        renderTable();
    }

    function updatePaginationControls(total) {
        const maxPage = Math.ceil(total / ITEMS_PER_PAGE) || 1;
        document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${maxPage}`;
        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = currentPage === maxPage;
    }

    // --- 5. FORM SUBMISSION ---
    document.getElementById('opsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Final Data Integrity Check
        if (invalidIds.length > 0) {
            alert("Please fix the invalid Store IDs listed at the bottom before submitting.");
            document.getElementById('submissionError').scrollIntoView({behavior: "smooth"});
            return;
        }
        
        if (validStores.length === 0) {
            alert("Please verify and select at least one valid store.");
            return;
        }

        const btn = document.getElementById('submitBtn');
        const originalText = btn.innerText;
        btn.textContent = "Processing...";
        btn.disabled = true;

        // Simulate API delay
        setTimeout(() => {
            alert(`Success! Adhoc Post created for ${validStores.length} stores.`);
            btn.textContent = originalText;
            btn.disabled = false;
        }, 1500);
    });

    // --- 6. FILE UI HELPERS ---
    document.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', function() {
            const fileName = this.files[0] ? this.files[0].name : "Drag and drop or click to select CSV";
            this.parentElement.querySelector('.file-msg').textContent = fileName;
            this.parentElement.classList.add('active');
        });
    });

    // --- 7. PAST SUBMISSIONS HELPER ---
    function loadPreviousPost(title) {
        alert(`Loading editor for previous post: "${title}"...\n(This would pre-fill the form in a real app)`);
        window.scrollTo({ top: 0, behavior: 'smooth' });
        document.getElementById('postTitle').value = title;
        // Logic to pre-fill other fields would go here
    }

</script>

</body>
</html>
